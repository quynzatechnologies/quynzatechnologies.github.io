<!DOCTYPE html>
<html lang="es">

<head>
    <script src="/js/load_html_created.js" defer></script>
    <script src="/js/logout_iot.js" defer></script>
    <script src="//code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js"></script>
    <script src="/js/front.js"></script>
    <script src="/js/owl.carousel.min.js"></script>
    
    <title>Ejercicio 4: Crear servidor web en ESP32 e interfaz web</title>
</head>

<body>
    <div id="all">
        <header id="header-comm-container"></header>

        <header id="header-nav-main-container"></header>

        <main>
			<div id="aside-nav-curso-iot-container"></div>

            <div class="content">
                <section>
                    <div id="heading-breadcrumbs">
                        <div class="container">
                            <div class="row">
                                <div class="col-md-12">
                                    <h1>Ejercicio 4: Crear servidor web en ESP32 e interfaz web</h1>
                                    <button id="cerrar-sesion" class="btn btn-neutral float-right" onclick="cerrarSesion()">Cerrar sesión</button>
								</div>
                            </div>
                        </div>
                    </div>

                    <div role="navegation" arial-label="Page navigation">
                        <ul class="wy-breadcrumbs">
                            <li class="wy-li">
                                <a href="/products/curso_iot/contenido/index.html">Inicio</a>
                            </li>
                            <li class="wy-li">
                                <a href="/products/curso_iot/contenido/clases/index.html">Clases y Actividades Prácticas</a>
                            </li>
                            <li class="wy-li">
                                <a href="/products/curso_iot/contenido/clases/ejercicios_basicos/index.html">Ejercicios básicos comunicación ESP32</a>
                            </li>
                            <li class="wy-li">
                                <a href="/products/curso_iot/contenido/clases/ejercicios_basicos/ejercicio_4.html" class="not-active">Ejercicio 4: Crear servidor web en ESP32 e interfaz web</a>
                            </li>
                        </ul>
                        <hr>
                    </div>
                </section>
            
                <section>
                    <div id="content">
                        <div class="container" id="contact">
                            <div class="row">
                                <div class="col-md-8">
                                    <section>
                                        <p>Todas las páginas web que se ven en internet están alojadas en un servidor, que continuamente esperar conexiones de clientes. En el caso de un ESP32, se crea un objeto tipo socket.socket que están escucha para atender solicitudes externas y el servidor debe dar respuestas a estas. Tantos las solicitudes como las respuestas de deben dar en un formato HTML.
                                        </p>
                                        <p>El programa se va a dividir en tres partes:
                                        </p>
                                        <ol>
                                            <li>boot.py: Script de Python especial que siempre se ejecuta al encender el ESP32.</li>
                                            <li>main.py: Script principal de Python.</li>
                                            <li>html_led.html: Texto HTML para interfaz gráfica del ejercicio.</li>
                                        </ol>

                                        <p>boot.py:</p>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%"><span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">machine</span> <span style="color: #8B008B; font-weight: bold">import</span> Pin
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">network</span>

p2 = Pin(<span style="color: #B452CD">2</span>,Pin.OUT)

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">do_connect</span>(ssid,pwd):
    <span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">network</span>
    wlan = network.WLAN(network.STA_IF)
    wlan.active(<span style="color: #658b00">True</span>)
    <span style="color: #8B008B; font-weight: bold">if</span> <span style="color: #8B008B">not</span> wlan.isconnected():
        p2.off()
        <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;connecting to network...&#39;</span>)
        wlan.connect(ssid, pwd)
        <span style="color: #8B008B; font-weight: bold">while</span> <span style="color: #8B008B">not</span> wlan.isconnected():
            <span style="color: #8B008B; font-weight: bold">pass</span>
        p2.on()

do_connect(<span style="color: #CD5555">&quot;XXX&quot;</span>,<span style="color: #CD5555">&quot;YYY&quot;</span>)
</pre>
</div>
    
                                        <p>main.py:</p>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%"><span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">machine</span> <span style="color: #8B008B; font-weight: bold">import</span> Pin
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">socket</span>

p2 = Pin(<span style="color: #B452CD">2</span>,Pin.OUT)

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">web_page</span>():
    <span style="color: #8B008B; font-weight: bold">if</span> led.value() == <span style="color: #B452CD">1</span>:
        gpio_state=<span style="color: #CD5555">&quot;ON&quot;</span>
    <span style="color: #8B008B; font-weight: bold">else</span>:
        gpio_state=<span style="color: #CD5555">&quot;OFF&quot;</span>
    
    f = <span style="color: #658b00">open</span>(<span style="color: #CD5555">&#39;html_led.txt&#39;</span>)
    text = f.read()
    f.close()
    
    html = text <span style="color: #a61717; background-color: #e3d2d2">$</span>{gpio_state}
    <span style="color: #8B008B; font-weight: bold">return</span> html

<span style="color: #228B22"># Create a Socket</span>
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
<span style="color: #228B22"># Bind the socket to a IP Address and Port</span>
s.bind((<span style="color: #CD5555">&#39;web-server-led.com&#39;</span>, <span style="color: #B452CD">80</span>))
<span style="color: #228B22"># Accept maximum 5 connections</span>
s.listen(<span style="color: #B452CD">5</span>)

<span style="color: #8B008B; font-weight: bold">while</span> <span style="color: #658b00">True</span>:
    <span style="color: #228B22"># When a client connects, the connection is accepted</span>
    conn, addr = s.accept()
    <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;Got a connection from %s&#39;</span> % <span style="color: #658b00">str</span>(addr))
    
    <span style="color: #228B22"># Get the received request of the client</span>
    request = conn.recv(<span style="color: #B452CD">1024</span>)
    request = <span style="color: #658b00">str</span>(request)
    <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;Content = %s&#39;</span> % request)
    
    <span style="color: #228B22"># Find commands of client to turn ON/OFF the led</span>
    led_on = request.find(<span style="color: #CD5555">&#39;/?led=on&#39;</span>)
    led_off = request.find(<span style="color: #CD5555">&#39;/?led=off&#39;</span>)
    <span style="color: #8B008B; font-weight: bold">if</span> led_on == <span style="color: #B452CD">6</span>:
        <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;LED ON&#39;</span>)
        led.value(<span style="color: #B452CD">1</span>)
    <span style="color: #8B008B; font-weight: bold">if</span> led_off == <span style="color: #B452CD">6</span>:
        <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;LED OFF&#39;</span>)
        led.value(<span style="color: #B452CD">0</span>)
        
    <span style="color: #228B22"># Generate the HTML text of Web Site</span>
    response = web_page()
    
    <span style="color: #228B22"># Send the responde to client following HTML protocols</span>
    conn.send(<span style="color: #CD5555">&#39;HTTP/1.1 200 OK\n&#39;</span>)
    conn.send(<span style="color: #CD5555">&#39;Content-Type: text/html\n&#39;</span>)
    conn.send(<span style="color: #CD5555">&#39;Connection: close\n\n&#39;</span>)
    conn.sendall(response)
    
    <span style="color: #228B22"># Close Socket</span>
    conn.close()
</pre>
</div>

                                        <p>El script </p>
                                    </section>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <footer>
                    <hr>
                    <div role="navegation" arial-label="Button navigation">
                        <a href="/products/curso_iot/contenido/clases/ejercicios_basicos/ejercicio_3.html" class="btn btn-neutral float-left" title="Ejercicio 3: Crear red WiFi" accesskey="p" rel="prev">
                            <span class="fa fa-arrow-circle-left" aria-hidden="true"></span>
                            Anterior
                        </a>
                        <a href="/products/curso_iot/contenido/clases/ejercicios_basicos/ejercicio_5.html" class="btn btn-neutral float-right" title="Ejercicio 5: Utilizar módulo Bluetooth de ESP32" accesskey="n" rel="next">
                            <span class="fa fa-arrow-circle-right" aria-hidden="true"></span>
                            Siguiente
                        </a>
                    </div>
                </footer>
            </div>
        </main>

        <footer class="footer" id="footer-main-container"></footer>

        <div class="copyright" id="footer-copyright-container"></div>
    </div>
</body>
</html>
