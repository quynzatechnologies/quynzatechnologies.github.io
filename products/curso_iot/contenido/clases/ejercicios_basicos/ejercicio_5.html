<!DOCTYPE html>
<html lang="es">

<head>
    <script src="/js/load_html_created.js" defer></script>
    <script src="/js/logout_iot.js" defer></script>
    <script src="//code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js"></script>
    <script src="/js/front.js"></script>
    <script src="/js/owl.carousel.min.js"></script>
    
    <title>Ejercicio 5: Crear servidor web en ESP32 e interfaz web</title>
</head>

<body>
    <div id="all">
        <header id="header-comm-container"></header>

        <header id="header-nav-main-container"></header>

        <main>
			<div id="aside-nav-curso-iot-container"></div>

            <div class="content">
                <section>
                    <div id="heading-breadcrumbs">
                        <div class="container">
                            <div class="row">
                                <div class="col-md-12">
                                    <h1>Ejercicio 5: Crear servidor web en ESP32 e interfaz web</h1>
                                    <button id="cerrar-sesion" class="btn btn-neutral float-right" onclick="cerrarSesion()">Cerrar sesión</button>
								</div>
                            </div>
                        </div>
                    </div>

                    <div role="navegation" arial-label="Page navigation">
                        <ul class="wy-breadcrumbs">
                            <li class="wy-li">
                                <a href="/products/curso_iot/contenido/index.html">Inicio</a>
                            </li>
                            <li class="wy-li">
                                <a href="/products/curso_iot/contenido/clases/index.html">Clases y Actividades Prácticas</a>
                            </li>
                            <li class="wy-li">
                                <a href="/products/curso_iot/contenido/clases/ejercicios_basicos/index.html">Ejercicios básicos comunicación ESP32</a>
                            </li>
                            <li class="wy-li">
                                <a href="/products/curso_iot/contenido/clases/ejercicios_basicos/ejercicio_5.html" class="not-active">Ejercicio 5: Crear servidor web en ESP32 e interfaz web</a>
                            </li>
                        </ul>
                        <hr>
                    </div>
                </section>
            
                <section>
                    <div id="content">
                        <div class="container" id="contact">
                            <div class="row">
                                <div class="col-md-8">
                                    <section>
                                        <h1>Descripción</h1>
                                        <p>Todas las páginas web que se ven en internet están alojadas en un servidor, que continuamente esperar conexiones de clientes. Usando 
                                            Micropython, con el <strong>Ejercicio 5: Crear servidor web en ESP32 e interfaz web</strong> se va a aprender a crear un servidor Web
                                            en el cual se muestre una interfaz sencilla en cualquier navegador.
                                        </p>

                                        <p> Para este ejercicio se necesita el <a href="/products/entrenadoresp32/index.html">Entrenador ESP32</a>, el cual puede ser adquirido en este link al mejor precio!
                                        </p>

                                        <p style="text-align:center;">
                                            <img src="/img/entrenador_esp32.jpg" width ="100%" height="auto">
                                        </p>

                                        <h1>Código</h1>
                                        <p>Para este ejercicio se necesitará el archivo:</p>
                                        <ol>
                                            <li>boot.py: Script de Python especial que siempre se ejecuta al encender el ESP32. Contiene el código para conexión a una red WiFi 
                                                específica</li>
                                            <li>main.py: Script principal de Python. Contiene el código para crear el servidor web y comunicarse con los clientes que se conecten.</li>
                                            <li>html_led.html: Texto HTML para interfaz gráfica del ejercicio.</li>
                                        </ol>

                                        <h3>boot.py:</h3>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">network</span>
<span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">machine</span> <span style="color: #8B008B; font-weight: bold">import</span> Pin

p2 = Pin(<span style="color: #B452CD">2</span>,Pin.OUT)

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">do_connect</span>(ssid,pwd):
    wlan = network.WLAN(network.STA_IF)
    wlan.active(<span style="color: #658b00">True</span>)
    <span style="color: #8B008B; font-weight: bold">if</span> <span style="color: #8B008B">not</span> wlan.isconnected():
        p2.off()
        <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;connecting to network...&#39;</span>)
        wlan.connect(ssid, pwd)
        <span style="color: #8B008B; font-weight: bold">while</span> <span style="color: #8B008B">not</span> wlan.isconnected():
            <span style="color: #8B008B; font-weight: bold">pass</span>
        p2.on()

do_connect(<span style="color: #CD5555">&quot;XXX&quot;</span>,<span style="color: #CD5555">&quot;YYY&quot;</span>)
</pre>
</div>
    
                                        <h3>main.py:</h3>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
<span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">machine</span> <span style="color: #8B008B; font-weight: bold">import</span> Pin
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">socket</span>

p2 = Pin(<span style="color: #B452CD">2</span>,Pin.OUT)

<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">web_page</span>():
    <span style="color: #8B008B; font-weight: bold">if</span> p2.value() == <span style="color: #B452CD">1</span>:
        gpio_state=<span style="color: #CD5555">&quot;ON&quot;</span>
    <span style="color: #8B008B; font-weight: bold">else</span>:
        gpio_state=<span style="color: #CD5555">&quot;OFF&quot;</span>
    
    f = <span style="color: #658b00">open</span>(<span style="color: #CD5555">&#39;html_led.html&#39;</span>)
    text = f.read()
    f.close()
    
    html = <span style="color: #658b00">str</span>(text)
    html = <span style="color: #658b00">str</span>(html).replace(<span style="color: #CD5555">&quot;%led&quot;</span>, gpio_state)
    <span style="color: #8B008B; font-weight: bold">return</span> html

<span style="color: #228B22"># Create a Socket</span>
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
<span style="color: #228B22"># </span>
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span style="color: #B452CD">1</span>)
<span style="color: #228B22"># Bind the socket to a IP Address and Port</span>
s.bind((<span style="color: #CD5555">&#39;&#39;</span>,<span style="color: #B452CD">80</span>))
<span style="color: #228B22"># Accept maximum 5 connections</span>
s.listen(<span style="color: #B452CD">5</span>)

<span style="color: #8B008B; font-weight: bold">while</span> <span style="color: #658b00">True</span>:
    <span style="color: #228B22"># When a client connects, the connection is accepted</span>
    conn, addr = s.accept()
    <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;Got a connection from %s&#39;</span> % <span style="color: #658b00">str</span>(addr))
    
    <span style="color: #228B22"># Get the received request of the client</span>
    request = conn.recv(<span style="color: #B452CD">1024</span>)
    request = <span style="color: #658b00">str</span>(request)
    <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;Content = %s&#39;</span> % request)
    
    <span style="color: #228B22"># Find commands of client to turn ON/OFF the led</span>
    led_on = request.find(<span style="color: #CD5555">&#39;/?led=on&#39;</span>)
    led_off = request.find(<span style="color: #CD5555">&#39;/?led=off&#39;</span>)
    <span style="color: #8B008B; font-weight: bold">if</span> led_on == <span style="color: #B452CD">6</span>:
        <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;LED ON&#39;</span>)
        p2.value(<span style="color: #B452CD">1</span>)
    <span style="color: #8B008B; font-weight: bold">if</span> led_off == <span style="color: #B452CD">6</span>:
        <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;LED OFF&#39;</span>)
        p2.value(<span style="color: #B452CD">0</span>)
        
    <span style="color: #228B22"># Generate the HTML text of Web Site</span>
    response = web_page()
    
    <span style="color: #228B22"># Send the responde to client following HTML protocols</span>
    conn.send(<span style="color: #CD5555">&#39;HTTP/1.0 200 OK\r\nContent-type: text/html\r\n\r\n&#39;</span>)
    conn.sendall(response)
    
    <span style="color: #228B22"># Close Socket</span>
    conn.close()
</pre>
</div>    
                                        
                                        <h3>html_led.html:</h3>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
<span style="color: #1e889b">&lt;!DOCTYPE HTML&gt;</span>
<span style="color: #8B008B; font-weight: bold">&lt;html&gt;</span>
<span style="color: #8B008B; font-weight: bold">&lt;head&gt;</span> 
    <span style="color: #8B008B; font-weight: bold">&lt;title&gt;</span>ESP Web Server<span style="color: #8B008B; font-weight: bold">&lt;/title&gt;</span> 
    <span style="color: #8B008B; font-weight: bold">&lt;meta</span> <span style="color: #658b00">name=</span><span style="color: #CD5555">&quot;viewport&quot;</span> <span style="color: #658b00">content=</span><span style="color: #CD5555">&quot;width=device-width, initial-scale=1&quot;</span><span style="color: #8B008B; font-weight: bold">&gt;</span>
    <span style="color: #8B008B; font-weight: bold">&lt;link</span> <span style="color: #658b00">rel=</span><span style="color: #CD5555">&quot;icon&quot;</span> <span style="color: #658b00">href=</span><span style="color: #CD5555">&quot;data:,&quot;</span><span style="color: #8B008B; font-weight: bold">&gt;</span> 
    <span style="color: #8B008B; font-weight: bold">&lt;style&gt;</span>
    <span style="color: #8B008B; font-weight: bold">html</span>{<span style="color: #8B008B; font-weight: bold">font-family</span>: Helvetica; <span style="color: #8B008B; font-weight: bold">display</span>:<span style="color: #8B008B; font-weight: bold">inline</span>-<span style="color: #8B008B; font-weight: bold">block</span>; <span style="color: #8B008B; font-weight: bold">margin</span>: <span style="color: #B452CD">0px</span> <span style="color: #8B008B; font-weight: bold">auto</span>; <span style="color: #8B008B; font-weight: bold">text-align</span>: <span style="color: #8B008B; font-weight: bold">center</span>;}
    <span style="color: #8B008B; font-weight: bold">h1</span>{<span style="color: #8B008B; font-weight: bold">color</span>: <span style="color: #B452CD">#0F3376</span>; <span style="color: #8B008B; font-weight: bold">padding</span>: <span style="color: #B452CD">2</span>vh;}<span style="color: #8B008B; font-weight: bold">p</span>{<span style="color: #8B008B; font-weight: bold">font-size</span>: <span style="color: #B452CD">1</span>.<span style="color: #B452CD">5</span>rem;}
    <span style="color: #008b45; font-weight: bold">.button</span>{<span style="color: #8B008B; font-weight: bold">display</span>: <span style="color: #8B008B; font-weight: bold">inline</span>-<span style="color: #8B008B; font-weight: bold">block</span>; <span style="color: #8B008B; font-weight: bold">background-color</span>: <span style="color: #B452CD">#e7bd3b</span>; <span style="color: #8B008B; font-weight: bold">border</span>: <span style="color: #8B008B; font-weight: bold">none</span>; <span style="color: #8B008B; font-weight: bold">border</span>-radius: <span style="color: #B452CD">4px</span>; <span style="color: #8B008B; font-weight: bold">color</span>: <span style="color: #658b00">white</span>; <span style="color: #8B008B; font-weight: bold">padding</span>: <span style="color: #B452CD">16px</span> <span style="color: #B452CD">40px</span>; <span style="color: #8B008B; font-weight: bold">text-decoration</span>: <span style="color: #8B008B; font-weight: bold">none</span>; <span style="color: #8B008B; font-weight: bold">font-size</span>: <span style="color: #B452CD">30px</span>; <span style="color: #8B008B; font-weight: bold">margin</span>: <span style="color: #B452CD">2px</span>; <span style="color: #8B008B; font-weight: bold">cursor</span>: <span style="color: #8B008B; font-weight: bold">pointer</span>;}
    <span style="color: #008b45; font-weight: bold">.button2</span>{<span style="color: #8B008B; font-weight: bold">background-color</span>: <span style="color: #B452CD">#4286f4</span>;}
    <span style="color: #8B008B; font-weight: bold">&lt;/style&gt;</span>
<span style="color: #8B008B; font-weight: bold">&lt;/head&gt;</span>
<span style="color: #8B008B; font-weight: bold">&lt;body&gt;</span> 
    <span style="color: #8B008B; font-weight: bold">&lt;h1&gt;</span>ESP Web Server<span style="color: #8B008B; font-weight: bold">&lt;/h1&gt;</span> 
    <span style="color: #8B008B; font-weight: bold">&lt;p&gt;</span>GPIO state: <span style="color: #8B008B; font-weight: bold">&lt;strong&gt;</span> %led <span style="color: #8B008B; font-weight: bold">&lt;/strong&gt;&lt;/p&gt;</span>
    <span style="color: #8B008B; font-weight: bold">&lt;p&gt;&lt;a</span> <span style="color: #658b00">href=</span><span style="color: #CD5555">&quot;/?led=on&quot;</span><span style="color: #8B008B; font-weight: bold">&gt;&lt;button</span> <span style="color: #658b00">class=</span><span style="color: #CD5555">&quot;button&quot;</span><span style="color: #8B008B; font-weight: bold">&gt;</span>ON<span style="color: #8B008B; font-weight: bold">&lt;/button&gt;&lt;/a&gt;&lt;/p&gt;</span>
    <span style="color: #8B008B; font-weight: bold">&lt;p&gt;&lt;a</span> <span style="color: #658b00">href=</span><span style="color: #CD5555">&quot;/?led=off&quot;</span><span style="color: #8B008B; font-weight: bold">&gt;&lt;button</span> <span style="color: #658b00">class=</span><span style="color: #CD5555">&quot;button button2&quot;</span><span style="color: #8B008B; font-weight: bold">&gt;</span>OFF<span style="color: #8B008B; font-weight: bold">&lt;/button&gt;&lt;/a&gt;&lt;/p&gt;</span>
<span style="color: #8B008B; font-weight: bold">&lt;/body&gt;</span>
<span style="color: #8B008B; font-weight: bold">&lt;/html&gt;</span>
</pre></div>
    
                                        <h1>Explicación paso a paso:</h1>

                                        <h3>boot.py</h3>
                                        <p>Este es el mismo código definido en el <strong>Ejercicio 2: Conectarse a red WiFi</strong>, en el cual se da una 
                                            <a href="/products/curso_iot/contenido/clases/ejercicios_basicos/ejercicio_2.html#explicacion">explicación paso a paso</a>. Se debe tener
                                            en cuenta que se debe cambiar el contenido con la información de la red WiFi propia:
                                        </p>

                                        <ul>
                                            <li>XXX: Nombre de su red WiFi</li>
                                            <li>YYY: Contraseña de su red WiFi</li>
                                        </ul>

                                        <h3>main.py</h3>
                                        <h4>Sockets y su papel en la conexión cliente-servidor:</h4>

                                        <p>Los sockets son un componente esencial en la comunicación entre dispositivos en una red. En el contexto de IoT y en este ejercicio en 
                                            particular, el socket actúa como un punto de comunicación entre el ESP32 (cliente) y el servidor web. El socket permite al ESP32 enviar 
                                            y recibir datos utilizando protocolos de red, como HTTP, que es el protocolo que estamos empleando para realizar la solicitud GET.
                                        </p>

                                        <p>Un socket se puede imaginar como una "tubería" a través de la cual los datos fluyen entre el cliente y el servidor. El ESP32 utiliza un 
                                            socket para:
                                        </p>

                                        <ul>
                                            <li><strong>Conectarse al servidor web:</strong>  Especifica la dirección IP del servidor y el puerto que se usará para la comunicación (en este caso, el puerto 80, que es el estándar para HTTP).</li>
                                            <li><strong>Enviar solicitudes:</strong> El ESP32 envía una solicitud GET a través del socket, indicando al servidor qué recurso desea obtener.</li>
                                            <li><strong>Recibir respuestas:</strong> El servidor utiliza el mismo socket para enviar de vuelta el contenido solicitado, como el código HTML de la página web.</li>
                                        </ul>
                                        
                                        <p> Siguiendo el <a href="https://docs.micropython.org/en/latest/esp8266/tutorial/network_tcp.html#simple-http-server">tutorial</a> 
                                            oficial de módulo socket, para crear un servidor web se necesita crear un socket que escuche las solicitudes de clientes que requieran 
                                            entablar comunicación. Para redes de servidores TCP se sigue una serie de pasos para crear el socket, el cual se muestra en el siguiente 
                                            diagrama de flujo:
                                        </p>

                                        <p style="text-align:center;">
                                            <img src="/products/curso_iot/contenido/clases/ejercicios_basicos/img/Diagrama_ejercicio_4.png" width ="300" height="auto">
                                        </p>

                                        <ol>
                                            <li>Se crea el objeto <em>socket.socket(af=AF_INET, type=SOCK_STREAM, proto=IPPROTO_TCP, /)</em> con una configuración TCP</li>
                                            <li>Se llama la función <em>socket.bind(address)</em> para vincular el socket a una dirección</li>
                                            <li>Se llama la función <em>socket.listen([backlog])</em> para habilitar al servidor web para aceptar conexiones y delimita un máximo
                                            número de conexiones</li>
                                            <li>Se llama la función <em>socket.accept()</em> para aceptar una solicitud de conexión entrante de un cliente. El cual retorna un
                                            nuevo objeto socket, usado para enviar y recibir datos, y la dirección vinculada al socket</li>
                                            <li>Se llama las funciones <em>socket.send()</em> y <em>socket.recv()</em> para enviar y recibir datos al cliente, respectivamente.</li>
                                            <li>Se llama la función <em>socket.close()</em> para marcar el socket como cerrado y liberar todos los recursos</li>
                                        </ol>

                                        <p>Para más información de las diferentes funciones disponibles en la clase <em>socket</em> véase la 
                                            <a href="https://docs.micropython.org/en/latest/library/socket.html">documentación oficial</a>.</p>

                                        <p>Con lo anterior en claro, se procede a explicar el código desarrollado:</p>

                                        <p>En primer lugar importamos la librería <em><a href="https://docs.micropython.org/en/latest/library/socket.html">socket</a></em> y la clase
                                            <em><a href="https://docs.micropython.org/en/latest/library/machine.html">machine.Pin</a></em>. La clase <em>Pin</em> es usado para controlar
                                            los pines GPIO (General-purpose Input-Output) del ESP32:
                                        </p>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
<span style="color: #8B008B; font-weight: bold">from</span> <span style="color: #008b45; text-decoration: underline">machine</span> <span style="color: #8B008B; font-weight: bold">import</span> Pin
<span style="color: #8B008B; font-weight: bold">import</span> <span style="color: #008b45; text-decoration: underline">socket</span>
</pre>
</div>

                                        <p> Luego un objeto llamado <em>p2</em> con clase <em>Pin</em>, el cual se va a vincular con el <em>GPIO2</em> del ESP32 con una configuración
                                            en modo salida (<em>Pin.OUT</em>). Para las tarjetas ESP32, el <em>GPIO2</em> está conectado al led interno:
                                        </p>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
p2 = Pin(<span style="color: #B452CD">2</span>,Pin.OUT)
</pre>
</div>

                                        <p> Se crea una función llamada <em>web_page</em>. En este se llama la función <em>p2.value()</em> para determinar el estado LED <em>p2</em>:
                                            si está encendido entonces se define la variable <em>gpio_state</em> como "<em>ON</em>", en caso contrario como  como "<em>OFF</em>".
                                            Luego se procede a leer el archivo <em>html_led.html</em> que contiene la pagina web a mostrar en el servidor web, se convierte en un
                                            variable de tipo <em>String</em> y se usa la función <em>html.replace()</em> para reemplazar el string <em>%led</em> por el valor de 
                                            la variable <em>gpio_state</em>. Por último se retorna la pagina web modificada:
                                        </p>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
<span style="color: #8B008B; font-weight: bold">def</span> <span style="color: #008b45">web_page</span>():
    <span style="color: #8B008B; font-weight: bold">if</span> p2.value() == <span style="color: #B452CD">1</span>:
        gpio_state=<span style="color: #CD5555">&quot;ON&quot;</span>
    <span style="color: #8B008B; font-weight: bold">else</span>:
        gpio_state=<span style="color: #CD5555">&quot;OFF&quot;</span>
    
    f = <span style="color: #658b00">open</span>(<span style="color: #CD5555">&#39;html_led.html&#39;</span>)
    text = f.read()
    f.close()
    
    html = <span style="color: #658b00">str</span>(text)
    html = <span style="color: #658b00">str</span>(html).replace(<span style="color: #CD5555">&quot;%led&quot;</span>, gpio_state)
    <span style="color: #8B008B; font-weight: bold">return</span> html
</pre>
</div>

                                        <p>Siguiendo el diagrama de flujo para la creación de sockets, primero se crea el objeto <em>socket.socket()</em>, donde 
                                            <em>socket.AF_INET</em> se utiliza para definir el socket en la familia de direcciones IPv4, <em>socket.SOCK_STREAM</em> se utiliza para 
                                            definir el socket como tipo TCP. Luego se vincula el socket a la dirección web del dispositivo al puerto 80. Y se configura
                                            el socket para recibir máximo 5 conexiones de manera simultanea:
                                        </p>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
<span style="color: #228B22"># Create a Socket</span>
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
<span style="color: #228B22"># Bind the socket to a IP Address and Port</span>
s.bind((<span style="color: #CD5555">&#39;&#39;</span>,<span style="color: #B452CD">80</span>))
<span style="color: #228B22"># Accept maximum 5 connections</span>
s.listen(<span style="color: #B452CD">5</span>)
</pre>
</div>

                                        <p>Se procede a habilitar al socket a aceptar las conexiones entrantes de clientes que accedan a la dirección web especificada anteriormente y
                                            se imprime en consola la dirección del cliente:
                                        </p>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
<span style="color: #8B008B; font-weight: bold">while</span> <span style="color: #658b00">True</span>:
    <span style="color: #228B22"># When a client connects, the connection is accepted</span>
    conn, addr = s.accept()
    <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;Got a connection from %s&#39;</span> % <span style="color: #658b00">str</span>(addr))
</pre>
</div>

                                        <p>Luego se recibe los datos del socket enviados por el cliente, con un tamaño máximo de 1024 bits, se convierte en <em>String</em> y se 
                                            imprime en consola:
                                        </p>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
    <span style="color: #228B22"># Get the received request of the client</span>
    request = conn.recv(<span style="color: #B452CD">1024</span>)
    request = <span style="color: #658b00">str</span>(request)
    <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;Content = %s&#39;</span> % request)
</pre>
</div>

                                        <p>La pagina web tiene dos botones:
                                        </p>

                                        <ul>
                                            <li>Botón encendido (ON): Que envía el comando <em>/?led=on</em></li>
                                            <li>Botón apagado (OFF): Que envía el comando <em>/?led=off</em></li>
                                        </ul>

                                        <p>Cuando el cliente presiona alguno de los dos botones el cliente envía una solicitud al servidor que contiene el comando correspondiente.
                                        </p>

                                        <p>Con la función <em>request.find("XXX")</em> se busca el string "<em>XXX</em>" dentro del string "<em>request</em>". En caso que el valor 
                                            de está búsqueda sea igual a 6 (si se encontró) entonces se cambia el estado del LED mediante la función <em>p2.value(i)</em>:
                                        </p>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
    <span style="color: #228B22"># Find commands of client to turn ON/OFF the led</span>
    led_on = request.find(<span style="color: #CD5555">&#39;/?led=on&#39;</span>)
    led_off = request.find(<span style="color: #CD5555">&#39;/?led=off&#39;</span>)
    <span style="color: #8B008B; font-weight: bold">if</span> led_on == <span style="color: #B452CD">6</span>:
        <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;LED ON&#39;</span>)
        p2.value(<span style="color: #B452CD">1</span>)
    <span style="color: #8B008B; font-weight: bold">if</span> led_off == <span style="color: #B452CD">6</span>:
        <span style="color: #8B008B; font-weight: bold">print</span>(<span style="color: #CD5555">&#39;LED OFF&#39;</span>)
        p2.value(<span style="color: #B452CD">0</span>)
</pre>
</div>

                                        <p> Luego de definir la función <em>web_page</em>, se llama y este automáticamente va a generar el html de la página web con el valor actual
                                            del led:
                                        </p>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
    <span style="color: #228B22"># Generate the HTML text of Web Site</span>
    response = web_page()
</pre>
</div>

                                        <p> Después se envía los datos requeridos por el navegador del cliente para mostrar la página web (Encabezado + Contenido):
                                        </p>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
    <span style="color: #228B22"># Send the responde to client following HTML protocols</span>
    conn.send(<span style="color: #CD5555">&#39;HTTP/1.0 200 OK\r\nContent-type: text/html\r\n\r\n&#39;</span>)
    conn.sendall(response)
</pre>
</div>

                                        <p>Por último, se cierra el socket creado para el cliente:
                                        </p>

<div style="background: #eeeedd; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;">
<pre style="margin: 0; line-height: 125%">
    <span style="color: #228B22"># Close Socket</span>
    conn.close()
</pre>
</div>

                                        <h1>Testeo en ESP32</h1>
                                        <p>Primero, se realiza la conexión del ESP32 a nuestro ordenador mediante USB:</p>

                                        <p style="text-align:center;">
                                            <img src="/products/curso_iot/contenido/clases/ejercicios_basicos/img/Con_ESP32_ejercicio_1.png" width ="100%" height="auto">
                                        </p>

                                        <p>Luego de subir los archivos <em>boot.py</em> y <em>html_led.html</em> al dispositivo ESP32, en consola se va a mostrar:</p>

                                        <p style="text-align:center;">
                                            <img src="/products/curso_iot/contenido/clases/ejercicios_basicos/img/resultado1_ejercicio_4.png" width ="100%" height="auto">
                                        </p>

                                        <p>Se debe anotar el campo <em>IP address</em> para los siguientes pasos.</p>

                                        <p>Luego ejecutamos el script <em>main.py</em> mediante el software Thonny. Y con un computador o dispositivo móvil que esté conectado
                                            en la misma red WiFi que el ESP32, por medio de un navegador se debe conectar a la dirección web anotada en pasos anteriores:
                                        </p>

                                        <p style="text-align:center;">
                                            <img src="/products/curso_iot/contenido/clases/ejercicios_basicos/img/resultado2_ejercicio_4.png" width ="100%" height="auto">
                                        </p>

                                        <p> Si presionamos en botón <em>ON</em> se encenderá el led de ESP32 como se muestra a continuación:
                                        </p>

                                        <p style="text-align:center;">
                                            <img src="/products/curso_iot/contenido/clases/ejercicios_basicos/img/resultado3_ejercicio_4.png" width ="100%" height="auto">
                                        </p>

                                    </section>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <footer>
                    <hr>
                    <div role="navegation" arial-label="Button navigation">
                        <a href="/products/curso_iot/contenido/clases/ejercicios_basicos/ejercicio_4.html" class="btn btn-neutral float-left" title="Ejercicio 4: Acceder a dirección Web" accesskey="p" rel="prev">
                            <span class="fa fa-arrow-circle-left" aria-hidden="true"></span>
                            Anterior
                        </a>
                        <a href="/products/curso_iot/contenido/clases/ejercicios_servidor/index.html" class="btn btn-neutral float-right" title="Implementación de un servidor útil" accesskey="n" rel="next">
                            <span class="fa fa-arrow-circle-right" aria-hidden="true"></span>
                            Siguiente
                        </a>
                    </div>
                </footer>
            </div>
        </main>

        <footer class="footer" id="footer-main-container"></footer>

        <div class="copyright" id="footer-copyright-container"></div>
    </div>
</body>
</html>
